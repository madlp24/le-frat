{% extends "base.html" %}
{% load static %}

{% block title %}Checkout | Le Frat{% endblock %}

{% block content %}
<div class="container py-5">

  <div class="lf-page-head mb-4">
    <div>
      <p class="lf-eyebrow mb-2">CHECKOUT</p>
      <h1 class="m-0">Almost yours.</h1>
      <p class="text-muted m-0">Confirm delivery details and pay securely.</p>
    </div>
  </div>

  <div class="row g-4">

    <!-- LEFT: ORDER SUMMARY -->
    <div class="col-12 col-lg-5">
      <div class="card lf-card">
        <div class="card-body p-4">
          <h2 class="h5 fw-bold mb-3">Order summary</h2>

          {% if bag_items %}
            <ul class="list-group list-group-flush lf-summary">
              {% for item in bag_items %}
                <li class="list-group-item d-flex justify-content-between align-items-start">
                  <div class="me-3">
                    <div class="fw-bold">{{ item.product.name }}</div>
                    <div class="small text-muted">Qty: {{ item.quantity }}</div>
                  </div>
                  <div class="fw-bold">${{ item.line_total }}</div>
                </li>
              {% endfor %}
            </ul>

            <div class="mt-3 pt-3 border-top">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <span class="fw-bold">Subtotal</span>
                <span class="fw-black">${{ subtotal|floatformat:2 }}</span>
              </div>
              <div class="d-flex justify-content-between align-items-center mb-2">
                <span class="fw-bold">Delivery</span>
                <span class="fw-black">${{ delivery_cost|floatformat:2 }}</span>
              </div>
              <div class="d-flex justify-content-between align-items-center">
                <span class="fw-bold">Grand total</span>
                <span class="h5 m-0 fw-black">${{ grand_total|floatformat:2 }}</span>
              </div>
            </div>

          {% else %}
            <div class="lf-empty-state">
              <p class="m-0">Your bag is empty.</p>
            </div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- RIGHT: DELIVERY + PAYMENT -->
    <div class="col-12 col-lg-7">
      <div class="card lf-card">
        <div class="card-body p-4 p-md-5">

          <h2 class="h5 fw-bold mb-3">Delivery & payment</h2>

          <form method="POST" id="payment-form" class="lf-checkout-form">
            {% csrf_token %}

            <div class="lf-checkout-grid">
              {{ order_form.as_p }}
            </div>

            <div class="mt-3">
              <label class="form-label fw-semibold">Card details</label>
              <div id="card-element" class="lf-stripe"></div>
              <div id="card-errors" class="text-danger small mt-2" role="alert"></div>
            </div>

            {% if not bag_items %}
            <script>
              document.getElementById("submit-button")?.setAttribute("disabled", "true");
            </script>
            {% endif %}
                            
            <div class="d-grid d-md-flex gap-2 mt-4">
              <a class="btn btn-outline-dark lf-btn-pill" href="{% url 'view_bag' %}">
                Back to bag
              </a>
              <button type="submit" id="submit-button" class="btn btn-primary lf-btn-pill">
                <span id="submit-button-text">Pay now</span>

                <span
                  id="submit-spinner"
                  class="spinner-border spinner-border-sm ms-2 d-none"
                  role="status"
                  aria-hidden="true">
                </span>
              </button>

              <div class="small text-muted mt-2" aria-live="polite" aria-atomic="true">
                <span id="payment-status-hint"></span>
              </div>

            </div>
          </form>

          <!-- Context to JS -->
          {{ stripe_public_key|json_script:"id_stripe_public_key" }}
          {{ client_secret|json_script:"id_client_secret" }}
          <script src="https://js.stripe.com/v3/"></script>
          <script src="{% static 'js/stripe_elements.js' %}"></script>

        </div>
      </div>
    </div>

  </div>
</div>
{% endblock %}
