{% extends "base.html" %}
{% load static %}

{% block title %}
  {% if product %}Edit{% else %}Add{% endif %} Product | Le Frat
{% endblock %}

{% block content %}
<div class="container py-4">

  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="m-0">
      {% if product %}Edit Product{% else %}Add Product{% endif %}
    </h1>
    <a class="btn btn-outline-primary" href="{% url 'products' %}">Back to shop</a>
  </div>

  <div class="card shadow-sm">
    <div class="card-body">

      {# Top-level errors #}
      {% if form.errors %}
        <div class="alert alert-danger">
          <strong>Please fix the errors below.</strong>
          {% if form.non_field_errors %}
            <div class="mt-2">{{ form.non_field_errors }}</div>
          {% endif %}
        </div>
      {% endif %}

      <form method="POST" enctype="multipart/form-data" novalidate>
        {% csrf_token %}

        <div class="row g-3">

          {# Category (optional) #}
          <div class="col-12 col-md-6">
            <label class="form-label" for="{{ form.category.id_for_label }}">Category</label>
            {{ form.category.as_widget }}
            {% if form.category.errors %}
              <div class="text-danger small mt-1">{{ form.category.errors|striptags }}</div>
            {% endif %}
            <div class="form-text">Optional. Helps customers browse.</div>
          </div>

          {# SKU (required, no spaces) #}
          <div class="col-12 col-md-6">
            <label class="form-label" for="{{ form.sku.id_for_label }}">SKU *</label>
            {{ form.sku.as_widget }}
            {% if form.sku.errors %}
              <div class="text-danger small mt-1">{{ form.sku.errors|striptags }}</div>
            {% endif %}
            <div class="form-text">Required. Unique. No spaces.</div>
          </div>

          {# Name (required) #}
          <div class="col-12">
            <label class="form-label" for="{{ form.name.id_for_label }}">Product name *</label>
            {{ form.name.as_widget }}
            {% if form.name.errors %}
              <div class="text-danger small mt-1">{{ form.name.errors|striptags }}</div>
            {% endif %}
          </div>

          {# Description (required) #}
          <div class="col-12">
            <label class="form-label" for="{{ form.description.id_for_label }}">Description *</label>
            {{ form.description.as_widget }}
            {% if form.description.errors %}
              <div class="text-danger small mt-1">{{ form.description.errors|striptags }}</div>
            {% endif %}
          </div>

          {# Price (required, >0) #}
          <div class="col-12 col-md-6">
            <label class="form-label" for="{{ form.price.id_for_label }}">Price *</label>
            {{ form.price.as_widget }}
            {% if form.price.errors %}
              <div class="text-danger small mt-1">{{ form.price.errors|striptags }}</div>
            {% endif %}
            <div class="form-text">Must be greater than 0 (e.g. 25.00).</div>
          </div>

          {# Stock (required, >=0) #}
          <div class="col-12 col-md-6">
            <label class="form-label" for="{{ form.stock.id_for_label }}">Stock *</label>
            {{ form.stock.as_widget }}
            {% if form.stock.errors %}
              <div class="text-danger small mt-1">{{ form.stock.errors|striptags }}</div>
            {% endif %}
            <div class="form-text">0 = Sold out.</div>
          </div>

          {# Image (optional) #}
          <div class="col-12">
            <label class="form-label" for="{{ form.image.id_for_label }}">Product image (optional)</label>
            {{ form.image.as_widget }}
            {% if form.image.errors %}
              <div class="text-danger small mt-1">{{ form.image.errors|striptags }}</div>
            {% endif %}

            {% if product and product.image %}
              <div class="mt-2 small">
                Current image:
                <a href="{{ product.image.url }}" target="_blank" rel="noopener">View</a>
              </div>
            {% endif %}
          </div>

        </div>

        <hr class="my-4">

        <div class="d-flex flex-wrap gap-2">
          <button class="btn btn-primary" type="submit">
            {% if product %}Save changes{% else %}Create product{% endif %}
          </button>
          <a class="btn btn-outline-secondary" href="{% url 'products' %}">Cancel</a>
        </div>

      </form>

    </div>
  </div>
</div>

<script>
  // Add Bootstrap classes + basic HTML validation attributes (front-end UX)
  (function () {
    const setAttrs = (id, attrs) => {
      const el = document.getElementById(id);
      if (!el) return;
      el.classList.add("form-control");
      Object.entries(attrs || {}).forEach(([k, v]) => el.setAttribute(k, v));
    };

    // Some widgets (like select / file) need different Bootstrap classes
    const setSelect = (id) => {
      const el = document.getElementById(id);
      if (!el) return;
      el.classList.add("form-select");
    };

    const setFile = (id) => {
      const el = document.getElementById(id);
      if (!el) return;
      el.classList.add("form-control");
      el.setAttribute("accept", "image/*");
    };

    setSelect("{{ form.category.id_for_label }}");

    setAttrs("{{ form.sku.id_for_label }}", {
      required: "required",
      maxlength: "20",
      autocomplete: "off",
      pattern: "^[^\\s]+$",
      title: "No spaces allowed"
    });

    setAttrs("{{ form.name.id_for_label }}", {
      required: "required",
      maxlength: "80"
    });

    // Make textarea styled like Bootstrap
    const desc = document.getElementById("{{ form.description.id_for_label }}");
    if (desc) {
      desc.classList.add("form-control");
      desc.setAttribute("required", "required");
      desc.setAttribute("rows", "5");
    }

    setAttrs("{{ form.price.id_for_label }}", {
      required: "required",
      min: "0.01",
      step: "0.01"
    });

    setAttrs("{{ form.stock.id_for_label }}", {
      required: "required",
      min: "0",
      step: "1"
    });

    setFile("{{ form.image.id_for_label }}");
  })();
</script>
{% endblock %}
